<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Draw Duel ‚Äî –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∏—Å—É–Ω–∫–∏</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <h1>ü§î –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∏—Å—É–Ω–∫–∏</h1>
    <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∏—Å—É–Ω–æ–∫, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ —É–≥–∞–¥–∞—Ç—å:</p>
    <ul id="drawingList"></ul>

    <script>
        async function loadAvailableDrawings() {
            const res = await fetch("/api/available-drawings");
            const drawings = await res.json();

            const list = document.getElementById("drawingList");
            list.innerHTML = ""; // –æ—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–∞

            if (drawings.length === 0) {
                list.innerHTML = "<li>–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∏—Å—É–Ω–∫–æ–≤.</li>";
                return;
            }

            for (const d of drawings) {
                const li = document.createElement("li");
                li.className = "drawing-item";

                const info = document.createElement("div");
                info.className = "drawing-info";
                info.innerHTML = `üé® –†–∏—Å—É–Ω–æ–∫ –æ—Ç <strong>${d.nickname}</strong>`;

                const canvas = document.createElement("canvas");
                canvas.width = 150;
                canvas.height = 150;

                const btn = document.createElement("button");
                btn.className = "guess-btn";
                btn.textContent = "–£–≥–∞–¥–∞—Ç—å";
                btn.onclick = () => goToView(d.id);

                li.appendChild(info);
                li.appendChild(canvas);
                li.appendChild(btn);
                list.appendChild(li);

                // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∏–Ω–∏-–ø—Ä–µ–≤—å—é
                try {
                    const drawRes = await fetch(`/api/draw/${d.id}`);
                    const data = await drawRes.json();
                    drawPreview(canvas, data.timeline);
                } catch(e) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–≤—å—é:", e);
                }
            }
        }

        function goToView(id) {
            window.location.href = `/view/${id}`;
        }

        function drawPreview(canvas, timeline) {
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 2;
            ctx.lineCap = "round";

            // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –ø–æ —Ä–∏—Å—É–Ω–∫—É, —á—Ç–æ–±—ã –ø–æ–º–µ—Å—Ç–∏—Ç—å –≤ –º–∏–Ω–∏-–∫–∞—Ä—Ç—É
            let minX = Infinity, minY = Infinity, maxX = 0, maxY = 0;
            timeline.forEach(p => {
                if (p.x !== undefined && p.y !== undefined) {
                    minX = Math.min(minX, p.x);
                    minY = Math.min(minY, p.y);
                    maxX = Math.max(maxX, p.x);
                    maxY = Math.max(maxY, p.y);
                }
            });
            const scaleX = canvas.width / (maxX - minX || 1);
            const scaleY = canvas.height / (maxY - minY || 1);
            const scale = Math.min(scaleX, scaleY) * 0.9; // –Ω–µ–º–Ω–æ–≥–æ –æ—Ç—Å—Ç—É–ø–∞

            let lastX, lastY;
            timeline.forEach(item => {
                if (item.type === "start") {
                    ctx.strokeStyle = item.color || "#000";
                    lastX = (item.x - minX) * scale + canvas.width*0.05;
                    lastY = (item.y - minY) * scale + canvas.height*0.05;
                } else if (item.type === "draw") {
                    const x = (item.x - minX) * scale + canvas.width*0.05;
                    const y = (item.y - minY) * scale + canvas.height*0.05;
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    lastX = x;
                    lastY = y;
                }
            });
        }

        loadAvailableDrawings();
    </script>
</body>
</html>
